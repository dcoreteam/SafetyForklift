<!DOCTYPE html>
<html data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <title>Site Management</title>
    <!-- Bootstrap 5 CSS -->
    <!--link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"-->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/sandstone/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <!-- เรียกใช้ Partial Navbar -->
    <%- include('partials/navbar') %>

    <div class="container mt-4">
      <h1>Site Management</h1>

      <!-- ปุ่ม Add Site -->
      <button
        class="btn btn-primary mb-3"
        data-bs-toggle="modal"
        data-bs-target="#siteModal"
        onclick="openAddSiteModal()"
      >
        Add Site
      </button>

      <!-- ตารางแสดง Site -->
      <table class="table table-bordered table-striped table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Site Name</th>
            <th>Company</th>
            <th>Contact Person</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (sites.length === 0) { %>
            <tr>
              <td colspan="7" class="text-center">No site found.</td>
            </tr>
          <% } else { %>
            <% sites.forEach(si => { %>
              <tr>
                <td><%= si.site_id %></td>
                <td><%= si.site_name %></td>
                <td><%= si.company_name %></td>
                <td><%= si.contact_person || '' %></td>
                <td><%= si.contact_phone || '' %></td>
                <td><%= si.contact_email || '' %></td>
                <td>
                  <!-- ปุ่ม Edit -->
                  <button
                    class="btn btn-sm btn-warning"
                    data-bs-toggle="modal"
                    data-bs-target="#siteModal"
                    onclick="openEditSiteModal(
                      <%= si.site_id %>,
                      '<%= si.site_name.replace(/'/g, '\\\'') %>',
                      <%= si.company_id %>,
                      '<%= si.contact_person ? si.contact_person.replace(/'/g, '\\\'') : '' %>',
                      '<%= si.contact_phone ? si.contact_phone.replace(/'/g, '\\\'') : '' %>',
                      '<%= si.contact_email ? si.contact_email.replace(/'/g, '\\\'') : '' %>'
                    )"
                  >
                    Edit
                  </button>
                  <!-- ปุ่ม Delete -->
                  <form
                    action="/management/site/delete/<%= si.site_id %>"
                    method="POST"
                    class="d-inline"
                    onsubmit="return confirm('Are you sure you want to delete this site?');"
                  >
                    <button type="submit" class="btn btn-sm btn-danger">
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>

    <!-- Modal สำหรับ Add/Edit Site -->
    <div
      class="modal fade"
      id="siteModal"
      tabindex="-1"
      aria-labelledby="siteModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="siteForm" method="POST">
            <div class="modal-header">
              <h5 class="modal-title" id="siteModalLabel">Add Site</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="siteId" />

              <div class="mb-3">
                <label for="name" class="form-label">Site Name:</label>
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  name="name"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="company_id" class="form-label">Company:</label>
                <select class="form-select" id="company_id" name="company_id">
                  <% companies.forEach(comp => { %>
                    <option value="<%= comp.id %>"><%= comp.name %></option>
                  <% }) %>
                </select>
              </div>

              <div class="mb-3">
                <label for="contact_person" class="form-label">Contact Person:</label>
                <input
                  type="text"
                  class="form-control"
                  id="contact_person"
                  name="contact_person"
                />
              </div>

              <div class="mb-3">
                <label for="contact_phone" class="form-label">Phone:</label>
                <input
                  type="text"
                  class="form-control"
                  id="contact_phone"
                  name="contact_phone"
                />
              </div>

              <div class="mb-3">
                <label for="contact_email" class="form-label">Email:</label>
                <input
                  type="email"
                  class="form-control"
                  id="contact_email"
                  name="contact_email"
                />
              </div>

            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    ></script>

    <script>
      // ฟังก์ชันเปิด Modal ในโหมด Add Site
      function openAddSiteModal() {
        document.getElementById('siteModalLabel').textContent = 'Add Site';
        document.getElementById('siteForm').action = '/management/site/add';

        // เคลียร์ฟอร์ม
        document.getElementById('siteId').value = '';
        document.getElementById('name').value = '';
        document.getElementById('company_id').selectedIndex = 0;
        document.getElementById('contact_person').value = '';
        document.getElementById('contact_phone').value = '';
        document.getElementById('contact_email').value = '';
      }

      // ฟังก์ชันเปิด Modal ในโหมด Edit Site
      function openEditSiteModal(
        siteId,
        siteName,
        companyId,
        contactPerson,
        contactPhone,
        contactEmail
      ) {
        document.getElementById('siteModalLabel').textContent = 'Edit Site';
        document.getElementById('siteForm').action = '/management/site/edit/' + siteId;

        document.getElementById('siteId').value = siteId;
        document.getElementById('name').value = siteName;
        document.getElementById('company_id').value = companyId;
        document.getElementById('contact_person').value = contactPerson;
        document.getElementById('contact_phone').value = contactPhone;
        document.getElementById('contact_email').value = contactEmail;
      }
    </script>
  </body>
</html>
